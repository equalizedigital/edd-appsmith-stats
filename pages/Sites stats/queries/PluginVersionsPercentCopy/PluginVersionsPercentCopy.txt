SELECT IF(RANK <= 10, version, 'Other') AS version_group,
       SUM(site_count) * 100.0 / total_count AS percentage
FROM (
	SELECT version, COUNT(id) AS site_count,
	ROW_NUMBER() OVER (ORDER BY COUNT(id) DESC) AS RANK
	FROM wp_edd_all_sites
	WHERE check_date >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
	GROUP BY version
) grouped_versions
CROSS JOIN (SELECT COUNT(id) AS total_count FROM wp_edd_all_sites
						WHERE check_date >= DATE_SUB(NOW(), INTERVAL 1 MONTH)) t
GROUP BY version_group
ORDER BY percentage DESC;
